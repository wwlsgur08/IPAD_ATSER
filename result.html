<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aster: ë‚˜ë§Œì˜ ë³„ìë¦¬ ì¹´ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        /* Prefer Playfair Display for English text */
        :lang(en) {
            font-family: 'Playfair Display', 'YESMyungJo', 'Nanum Myeongjo', serif !important;
        }
        
        /* Apply Playfair Display to elements with English content */
        .constellation-name[lang="en"] {
            font-family: 'Playfair Display', serif !important;
        }
        /* YESMyungJo (ì˜ˆìŠ¤ëª…ì¡°): map regular and bold to the same family */
        @font-face {
            font-family: 'YESMyungJo';
            src: local('YESMyungJo'), local('YES MyungJo'), local('YESMyungjo'), local('ì˜ˆìŠ¤ëª…ì¡°');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'YESMyungJo';
            src: local('YESMyungJo Bold'), local('YES MyungJo Bold'), local('YESMyungjo Bold'), local('ì˜ˆìŠ¤ëª…ì¡° Bold'), local('YESMyungjo-Bold'), local('YESMyungJo-Bold');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'YESMyungJo', 'Nanum Myeongjo', 'Playfair Display', serif;
            background: #000;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            justify-content: center;
        }
        
        .title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .cards-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .card {
            background: linear-gradient(145deg, #e8ecff 0%, #d1d9ff 100%);
            border-radius: 20px;
            padding: 20px;
            width: 360px;
            height: 520px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .star-corner {
            position: absolute;
            color: #6366f1;
            font-size: 1.5rem;
        }
        .star-corner.tl { top: 15px; left: 15px; }
        .star-corner.tr { top: 15px; right: 15px; }
        .star-corner.bl { bottom: 15px; left: 15px; }
        .star-corner.br { bottom: 15px; right: 15px; }
        
        .aster-logo {
            width: 80px;
            height: 32px;
            margin: -5px 0 25px 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .constellation-card .subtitle {
            color: #6366f1;
            font-size: 1rem;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 700;
            font-family: 'YESMyungJo', 'Nanum Myeongjo', serif;
        }
        
        .constellation-preview {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            margin: 3px 0;
            background: transparent;
        }

        .eye-background {
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 0;
            opacity: 1;
        }
        
        .constellation-name {
            color: #6366f1;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 25px 0 20px 0;
            text-align: center;
            font-family: 'YESMyungJo', 'Nanum Myeongjo', serif;
        }
        
        .constellation-bottom {
            color: #6366f1;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 14px;
            font-weight: 700;
            font-family: 'YESMyungJo', 'Nanum Myeongjo', serif;
        }
        
        .stats-list {
            flex: 1;
            width: 100%;
            margin: 20px 0;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .stat-name {
            font-size: 1rem;
            font-weight: 700;
            font-family: 'YESMyungJo', 'Nanum Myeongjo', serif;
        }
        
        .stat-value {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .qr-code {
            width: 80px;
            height: 80px;
            background: #6366f1;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
        }
        
        .buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            color: white;
            transition: transform 0.2s;
            font-family: 'Nanum Gothic', sans-serif;
        }
        
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #6366f1; }
        .btn-secondary { background: #10b981; }
        
        .star-field {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 3;
        }
        
        .constellation-star {
            position: absolute;
            transform: translate(-50%, -50%);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        #constellation-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        
        .constellation-line {
            stroke: rgba(255, 255, 255, 0.9);
            stroke-width: 3;
            stroke-linecap: round;
        }
        
        @media (max-width: 768px) {
            .cards-container { flex-direction: column; gap: 20px; }
            .card { width: 100%; max-width: 320px; height: auto; padding: 20px; }
            .constellation-preview { width: 200px; height: 200px; }
            .buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <h1 class="title">ë‚˜ë§Œì˜ ë§¤ë ¥ ë³„ìë¦¬ ì¹´ë“œ</h1>
    
    <div class="cards-container">
        <div class="card constellation-card">
            <div class="star-corner tl">âœ¦</div>
            <div class="star-corner tr">âœ¦</div>
            <div class="aster-logo" id="asterLogo"></div>
            <div class="subtitle">ì•„ë¦„ë‹¤ì›€ì´ ë¹„ë¡œì†Œ ë‚˜ë‹¤ì›€ìœ¼ë¡œ</div>
            
            <div class="constellation-preview">
                <div class="eye-background" id="eyeBackground"></div>
                <svg id="constellation-svg"></svg>
                <div class="star-field" id="starField"></div>
            </div>
            
            <div class="constellation-name" id="constellationName">Loading...</div>
            <div class="constellation-bottom">ë§ˆì¹¨ë‚´ ë°œê²¬í•œ ë‚˜ë§Œì˜ ë³„</div>
            <div class="star-corner bl">âœ¦</div>
            <div class="star-corner br">âœ¦</div>
        </div>

        <div class="card stats-card">
            <div class="star-corner tl">âœ¦</div>
            <div class="star-corner tr">âœ¦</div>
            <div class="aster-logo" id="asterLogo2"></div>
            
            <div class="stats-list" id="statsList"></div>
            
            <div class="constellation-bottom">ë§ˆì¹¨ë‚´ ë°œê²¬í•œ ë‚˜ë§Œì˜ ë³„</div>
            <div class="star-corner bl">âœ¦</div>
            <div class="star-corner br">âœ¦</div>
        </div>
    </div>

    <div class="buttons">
        <button class="btn btn-secondary" onclick="downloadCard()">ì¹´ë“œ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-primary" onclick="sendTo3DConstellation()">3D ë³„ìë¦¬ì— ì¶”ê°€</button>
        <a href="main.html" class="btn btn-primary">ë‹¤ì‹œ ë§Œë“¤ê¸°</a>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyBcl4tKzcneq6yn6mmADC5YzoVGmRnsZbk",
            authDomain: "dinteraction-e0393.firebaseapp.com",
            databaseURL: "https://dinteraction-e0393-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "dinteraction-e0393",
            storageBucket: "dinteraction-e0393.firebasestorage.app",
            messagingSenderId: "845988355289",
            appId: "1:845988355289:web:b5243b16e80bfb9cbf32c8",
            measurementId: "G-QG1QWM3LSC"
        };
        
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        console.log('ğŸ”¥ Firebase ì´ˆê¸°í™” ì™„ë£Œ');
    
        const categoryInfo = {
            "ì´í•´ì‹¬ ë° ê³µê° ëŠ¥ë ¥": { color: "#D726BD", starImage: "star-pink.png", shortName: "ë¦¬ë”ì‹­", colorName: "pink", bgColor: "#FFE7FB" },
            "ì„±ì‹¤ì„± ë° ì±…ì„ê°": { color: "#1A99B6", starImage: "star-skyblue.png", shortName: "ë°°ë ¤ì‹¬", colorName: "skyblue", bgColor: "#E7FBFF" },
            "ì§€ì  í˜¸ê¸°ì‹¬ ë° ê°œë°©ì„±": { color: "#CD9F1F", starImage: "star-yellow.png", shortName: "ê³„íšì„±", colorName: "yellow", bgColor: "#FEFFE4" },
            "ì •ì„œì  ì•ˆì • ë° ìê¸° ì¸ì‹": { color: "#1BC14D", starImage: "star-green.png", shortName: "ìê¸° ê°ê´€í™”", colorName: "green", bgColor: "#E7FFEC" },
            "ë„ë•ì„± ë° ì–‘ì‹¬": { color: "#4169E1", starImage: "star-blue.png", shortName: "í¬ìš©ë ¥", colorName: "blue", bgColor: "#E7F1FF" },
            "ìœ ë¨¸ê°ê° ë° ì‚¬êµì„±": { color: "#D1791A", starImage: "star-orange.png", shortName: "ë„“ì€ ì‹œì•¼", colorName: "orange", bgColor: "#FFEFE4" },
            "ëª©í‘œ ì§€í–¥ì„± ë° ì•¼ë§": { color: "#CE2629", starImage: "star-red.png", shortName: "ì„±ì‹¤í•¨", colorName: "red", bgColor: "#FFE7E7" }
        };

        const symbols = { 0: "â™¦", 1: "â™¦", 2: "â™¦", 3: "â™¦", 4: "â™¦", 5: "â™¦", 6: "â™¦" };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Result Page] DOMContentLoaded ì‹œì‘');
            const savedData = localStorage.getItem('asterResultData');
            console.log('[Result Page] localStorage ë°ì´í„°:', savedData ? 'ìˆìŒ' : 'ì—†ìŒ');
            
            if (!savedData) {
                console.error('[Result Page] asterResultDataê°€ ì—†ìŠµë‹ˆë‹¤!');
                alert('ê²°ê³¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. main.htmlì—ì„œ ë³„ìë¦¬ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.');
                window.location.href = 'main.html';
                return;
            }

            let resultData;
            try {
                resultData = JSON.parse(savedData);
                console.log('[Result Page] ë°ì´í„° íŒŒì‹± ì„±ê³µ:', resultData);
            } catch (error) {
                console.error('[Result Page] JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                alert('ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
                return;
            }
            
            // ê°€ì¥ ë†’ì€ ë ˆë²¨ì˜ ë³„ ì°¾ê¸°
            let highestLevelCharm = null;
            let maxLevel = 0;
            
            console.log('[Result Page] charms ê°œìˆ˜:', resultData.charms ? resultData.charms.length : 0);
            
            if (!resultData.charms || resultData.charms.length === 0) {
                console.error('[Result Page] charmsê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');
                alert('ë§¤ë ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            resultData.charms.forEach(charm => {
                if (charm.level > maxLevel) {
                    maxLevel = charm.level;
                    highestLevelCharm = charm;
                }
            });
            
            console.log('[Result Page] ê°€ì¥ ë†’ì€ ë ˆë²¨ ë§¤ë ¥:', highestLevelCharm);
            
            // ê°€ì¥ ë†’ì€ ë ˆë²¨ ë³„ì˜ ì¹´í…Œê³ ë¦¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const dominantCategoryInfo = highestLevelCharm ? categoryInfo[highestLevelCharm.category] : null;
            const colorName = dominantCategoryInfo ? dominantCategoryInfo.colorName : 'blue';
            const bgColor = dominantCategoryInfo ? dominantCategoryInfo.bgColor : '#E7F1FF';
            
            console.log('[Result Page] colorName:', colorName);
            
            // ë³„ìë¦¬ ì´ë¦„ ì„¤ì •
            const nameEl = document.getElementById('constellationName');
            nameEl.textContent = `${resultData.userName || 'User'}'s Constellation`;
            nameEl.setAttribute('lang', 'en');
            console.log('[Result Page] ë³„ìë¦¬ ì´ë¦„ ì„¤ì • ì™„ë£Œ:', nameEl.textContent);
            
            // ì¹´ë“œ ë°°ê²½ìƒ‰ ë³€ê²½
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.style.background = `linear-gradient(145deg, ${bgColor} 0%, ${bgColor}dd 100%)`;
            });

            // Apply dominant theme color to text and corner stars
            const themeColor = dominantCategoryInfo ? dominantCategoryInfo.color : '#4169E1';
            document.querySelectorAll('.subtitle, .constellation-name, .constellation-bottom, .star-corner').forEach(el => {
                el.style.color = themeColor;
            });
            
            // ë¡œê³  ì´ë¯¸ì§€ ì„¤ì •
            const logoElements = [document.getElementById('asterLogo'), document.getElementById('asterLogo2')];
            logoElements.forEach(logo => {
                if (logo) {
                    logo.style.backgroundImage = `url('./images/logo-${colorName}.png')`;
                }
            });
            
            // ëˆˆ ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì •
            const eyeBackground = document.getElementById('eyeBackground');
            if (eyeBackground) {
                const eyeImagePath = `./images/eye-${colorName}.png`;
                console.log('ëˆˆ ì´ë¯¸ì§€ ê²½ë¡œ:', eyeImagePath);
                console.log('colorName:', colorName);
                eyeBackground.style.backgroundImage = `url('${eyeImagePath}')`;
                console.log('eyeBackground ìš”ì†Œ:', eyeBackground);
                console.log('eyeBackground ìŠ¤íƒ€ì¼:', eyeBackground.style);
            } else {
                console.log('eyeBackground ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }

            // ë³„ë“¤ ìƒì„±
            const starField = document.getElementById('starField');
            const svg = document.getElementById('constellation-svg');
            
            resultData.charms.forEach(charm => {
                const star = document.createElement('div');
                star.className = 'constellation-star';
                star.style.left = `${charm.position.x}%`;
                star.style.top = `${charm.position.y}%`;
                // Use each charm's original star image (preserve per-charm color)
                star.style.backgroundImage = `url(./images/${charm.starImage})`;
                
                const size = charm.level > 0 ? 40 + (charm.level * 50) : 0;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                
                starField.appendChild(star);
            });

            // ì—°ê²°ì„  ìƒì„±
            console.log('ì—°ê²°ì„  ë°ì´í„°:', resultData.lines);
            resultData.lines.forEach(line => {
                const startCharm = resultData.charms.find(c => c.name === line.start);
                const endCharm = resultData.charms.find(c => c.name === line.end);
                
                if (startCharm && endCharm) {
                    console.log(`ì—°ê²°ì„  ìƒì„±: ${startCharm.name} -> ${endCharm.name}`);
                    const lineEl = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    lineEl.setAttribute('x1', `${startCharm.position.x}%`);
                    lineEl.setAttribute('y1', `${startCharm.position.y}%`);
                    lineEl.setAttribute('x2', `${endCharm.position.x}%`);
                    lineEl.setAttribute('y2', `${endCharm.position.y}%`);
                    lineEl.className = 'constellation-line';
                    lineEl.setAttribute('stroke', 'rgba(255, 255, 255, 0.9)');
                    lineEl.setAttribute('stroke-width', '2');
                    svg.appendChild(lineEl);
                    console.log('ì—°ê²°ì„  ì¶”ê°€ë¨:', lineEl);
                } else {
                    console.log('ì—°ê²°ì„  ë§¤ë ¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', line);
                }
            });

            // í†µê³„ ìƒì„± - ê°œë³„ ë§¤ë ¥ë“¤ì„ ë ˆë²¨ ìˆœìœ¼ë¡œ í‘œì‹œ
            const statsList = document.getElementById('statsList');
            
            resultData.charms
                .sort((a, b) => b.level - a.level)
                .slice(0, 8)
                .forEach(charm => {
                    const info = categoryInfo[charm.category];
                    const item = document.createElement('div');
                    item.className = 'stat-item';
                    item.innerHTML = `
                        <div class="stat-name" style="color: ${info.color}">${charm.name}</div>
                        <div class="stat-value">
                            <span style="color: ${info.color}">â™¦</span>
                            <span>${charm.level}</span>
                        </div>
                    `;
                    statsList.appendChild(item);
                });
        });

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë”© í•¨ìˆ˜
        function preloadImages() {
            return new Promise((resolve) => {
                const images = document.querySelectorAll('.aster-logo, .eye-background');
                let loadedCount = 0;
                const totalImages = images.length;
                
                if (totalImages === 0) {
                    resolve();
                    return;
                }
                
                images.forEach(img => {
                    const computedStyle = window.getComputedStyle(img);
                    const backgroundImage = computedStyle.backgroundImage;
                    
                    if (backgroundImage && backgroundImage !== 'none') {
                        const imageUrl = backgroundImage.slice(4, -1).replace(/"/g, "");
                        const image = new Image();
                        image.crossOrigin = 'anonymous';
                        image.onload = () => {
                            loadedCount++;
                            if (loadedCount === totalImages) {
                                resolve();
                            }
                        };
                        image.onerror = () => {
                            loadedCount++;
                            if (loadedCount === totalImages) {
                                resolve();
                            }
                        };
                        image.src = imageUrl;
                    } else {
                        loadedCount++;
                        if (loadedCount === totalImages) {
                            resolve();
                        }
                    }
                });
            });
        }

        async function downloadCard() {
            const btn = event.target;
            btn.textContent = 'ì²˜ë¦¬ì¤‘...';
            btn.disabled = true;
            
            try {
                // ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë”©
                await preloadImages();
                
                const container = document.querySelector('.cards-container');
                const body = document.body;
                
                // ì„ì‹œë¡œ í˜ì´ì§€ ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ ë³€ê²½
                const originalBackground = body.style.background;
                body.style.background = 'transparent';
                
                // ì ì‹œ ëŒ€ê¸°í•˜ì—¬ ë Œë”ë§ ì™„ë£Œ ë³´ì¥
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const canvas = await html2canvas(container, { 
                    scale: 3, // ë” ë†’ì€ í•´ìƒë„
                    backgroundColor: null,
                    useCORS: true,
                    allowTaint: true,
                    imageTimeout: 15000,
                    logging: false,
                    removeContainer: true,
                    foreignObjectRendering: true
                });
                
                // ì›ë˜ ë°°ê²½ìœ¼ë¡œ ë³µì›
                body.style.background = originalBackground;
                
                const link = document.createElement('a');
                link.download = 'constellation-card.png';
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
            } catch (error) {
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë°°ê²½ ë³µì›
                document.body.style.background = '#000';
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
            }
            
            btn.textContent = 'ì¹´ë“œ ë‹¤ìš´ë¡œë“œ';
            btn.disabled = false;
        }

        // 3D ë³„ìë¦¬ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        async function sendTo3DConstellation() {
            try {
                const savedData = localStorage.getItem('asterResultData');
                if (!savedData) {
                    alert('ë³„ìë¦¬ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const resultData = JSON.parse(savedData);
                
                console.log('ğŸ“¸ ë³„ìë¦¬ ì´ë¯¸ì§€ ìº¡ì²˜ ì¤‘...');
                
                // ë³„ìë¦¬ í”„ë¦¬ë·° ë¶€ë¶„ë§Œ ìº¡ì²˜ (ë³„ + ì—°ê²°ì„ )
                const constellationPreview = document.querySelector('.constellation-preview');
                const eyeBackground = document.getElementById('eyeBackground');
                let cardImageData = null;
                
                try {
                    // ì›ë³¸ ìŠ¤íƒ€ì¼ ì €ì¥
                    const originalEyeDisplay = eyeBackground.style.display;
                    const originalBg = constellationPreview.style.background;
                    const originalBorderRadius = constellationPreview.style.borderRadius;
                    const originalOverflow = constellationPreview.style.overflow;
                    
                    // ìº¡ì²˜ë¥¼ ìœ„í•´ ì„ì‹œë¡œ ìŠ¤íƒ€ì¼ ë³€ê²½
                    eyeBackground.style.display = 'none'; // ëˆˆë™ì ìˆ¨ê¸°ê¸°
                    constellationPreview.style.background = 'transparent'; // ë°°ê²½ íˆ¬ëª…
                    constellationPreview.style.borderRadius = '0'; // ì›í˜• ë§ˆìŠ¤í‚¹ ì œê±°
                    constellationPreview.style.overflow = 'visible'; // ë³„ë¹›ì´ ë³´ì´ê²Œ
                    
                    // ì•½ê°„ ëŒ€ê¸° (ë Œë”ë§ ì™„ë£Œ)
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const canvas = await html2canvas(constellationPreview, {
                        scale: 2,
                        backgroundColor: null, // íˆ¬ëª… ë°°ê²½
                        useCORS: true,
                        allowTaint: true,
                        logging: false
                    });
                    
                    // ì›ë³¸ ìŠ¤íƒ€ì¼ ë³µì›
                    eyeBackground.style.display = originalEyeDisplay;
                    constellationPreview.style.background = originalBg;
                    constellationPreview.style.borderRadius = originalBorderRadius;
                    constellationPreview.style.overflow = originalOverflow;
                    
                    // ì´ë¯¸ì§€ ì••ì¶• (í’ˆì§ˆ 0.8ë¡œ ì•½ê°„ ë†’ì„)
                    cardImageData = canvas.toDataURL('image/png', 0.8);
                    console.log('âœ… ë³„ìë¦¬ ì´ë¯¸ì§€ ìº¡ì²˜ ì™„ë£Œ (í¬ê¸°:', Math.round(cardImageData.length / 1024), 'KB)');
                } catch (error) {
                    console.error('âŒ ë³„ìë¦¬ ìº¡ì²˜ ì‹¤íŒ¨:', error);
                    // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ìŠ¤íƒ€ì¼ ë³µì›
                    if (eyeBackground) eyeBackground.style.display = '';
                    if (constellationPreview) {
                        constellationPreview.style.background = '';
                        constellationPreview.style.borderRadius = '';
                        constellationPreview.style.overflow = '';
                    }
                }
                
                // 3D í”„ë¡œì íŠ¸ë¡œ ì „ì†¡í•  ë°ì´í„° ì¤€ë¹„
                const constellationData = {
                    name: `${resultData.userName}'s Constellation`,
                    userName: resultData.userName,
                    charms: resultData.charms.map(charm => ({
                        name: charm.name,
                        level: charm.level,
                        category: charm.category,
                        position: charm.position,
                        starImage: charm.starImage
                    })),
                    lines: resultData.lines || [],
                    totalLevel: resultData.charms.reduce((sum, charm) => sum + charm.level, 0),
                    timestamp: new Date().toISOString(),
                    cardImage: cardImageData // ë³„ìë¦¬ ì´ë¯¸ì§€ë§Œ ì¶”ê°€
                };

                console.log('ğŸŒŸ Firebaseë¡œ ë³„ìë¦¬ ì „ì†¡ ì¤‘... (ì´ í¬ê¸°:', Math.round(JSON.stringify(constellationData).length / 1024), 'KB)');

                // Firebase Realtime Databaseì— ë°ì´í„° ì¶”ê°€
                const newConstellationRef = database.ref('constellations').push();
                await newConstellationRef.set(constellationData);
                
                console.log('âœ… Firebaseì— ë³„ìë¦¬ ì¶”ê°€ ì™„ë£Œ!');
                
                alert('âœ¨ ë³„ìë¦¬ê°€ 3D ìš°ì£¼ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\nì»´í“¨í„° í™”ë©´ì„ í™•ì¸í•´ë³´ì„¸ìš”! ğŸŒŸ');
                
            } catch (error) {
                console.error('âŒ 3D ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('ë³„ìë¦¬ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
            }
        }
    </script>
</body>
</html>
