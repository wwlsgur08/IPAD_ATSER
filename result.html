<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aster: ÎÇòÎßåÏùò Î≥ÑÏûêÎ¶¨ Ïπ¥Îìú</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        /* Prefer Playfair Display for English text */
        :lang(en) {
            font-family: 'Playfair Display', 'YESMyungJo', 'Nanum Myeongjo', serif !important;
        }
        
        /* Apply Playfair Display to elements with English content */
        .constellation-name[lang="en"] {
            font-family: 'Playfair Display', serif !important;
        }
        /* YESMyungJo (ÏòàÏä§Î™ÖÏ°∞): map regular and bold to the same family */
        @font-face {
            font-family: 'YESMyungJo';
            src: local('YESMyungJo'), local('YES MyungJo'), local('YESMyungjo'), local('ÏòàÏä§Î™ÖÏ°∞');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'YESMyungJo';
            src: local('YESMyungJo Bold'), local('YES MyungJo Bold'), local('YESMyungjo Bold'), local('ÏòàÏä§Î™ÖÏ°∞ Bold'), local('YESMyungjo-Bold'), local('YESMyungJo-Bold');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'YESMyungJo', 'Nanum Myeongjo', 'Playfair Display', serif;
            background: #000;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            justify-content: center;
        }
        
        .title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .cards-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .card {
            background: linear-gradient(145deg, #e8ecff 0%, #d1d9ff 100%);
            border-radius: 20px;
            padding: 20px;
            width: 360px;
            height: 520px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .star-corner {
            position: absolute;
            color: #6366f1;
            font-size: 1.5rem;
        }
        .star-corner.tl { top: 15px; left: 15px; }
        .star-corner.tr { top: 15px; right: 15px; }
        .star-corner.bl { bottom: 15px; left: 15px; }
        .star-corner.br { bottom: 15px; right: 15px; }
        
        .aster-logo {
            width: 80px;
            height: 32px;
            margin: -5px 0 25px 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .constellation-card .subtitle {
            color: #6366f1;
            font-size: 1rem;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 700;
            font-family: 'YESMyungJo', 'Nanum Myeongjo', serif;
        }
        
        .constellation-preview {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            margin: 3px 0;
            background: transparent;
        }

        .eye-background {
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 0;
            opacity: 1;
        }
        
        .constellation-name {
            color: #6366f1;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 25px 0 20px 0;
            text-align: center;
            font-family: 'YESMyungJo', 'Nanum Myeongjo', serif;
        }
        
        .constellation-bottom {
            color: #6366f1;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 14px;
            font-weight: 700;
            font-family: 'YESMyungJo', 'Nanum Myeongjo', serif;
        }
        
        .stats-list {
            flex: 1;
            width: 100%;
            margin: 20px 0;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .stat-name {
            font-size: 1rem;
            font-weight: 700;
            font-family: 'YESMyungJo', 'Nanum Myeongjo', serif;
        }
        
        .stat-value {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .qr-code {
            width: 80px;
            height: 80px;
            background: #6366f1;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
        }
        
        .buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            color: white;
            transition: transform 0.2s;
            font-family: 'Nanum Gothic', sans-serif;
        }
        
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #6366f1; }
        .btn-secondary { background: #10b981; }
        
        .star-field {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 3;
        }
        
        .constellation-star {
            position: absolute;
            transform: translate(-50%, -50%);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        #constellation-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        
        .constellation-line {
            stroke: rgba(255, 255, 255, 0.9);
            stroke-width: 3;
            stroke-linecap: round;
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 24px;
                color: white !important;
                margin-bottom: 25px;
            }
            .cards-container { 
                flex-direction: column; 
                gap: 20px; 
                padding: 0 10px;
            }
            .card { 
                width: 100%; 
                max-width: 340px; 
                height: auto; 
                padding: 20px; 
                margin: 0 auto;
            }
            .constellation-preview { 
                width: 220px; 
                height: 220px; 
            }
            .subtitle {
                font-size: 13px;
            }
            .constellation-name {
                font-size: 18px;
            }
            .constellation-bottom {
                font-size: 13px;
            }
            .buttons { 
                flex-direction: column; 
                gap: 12px;
                padding: 0 10px;
                width: 100%;
            }
            .btn {
                width: 100%;
                max-width: 340px;
                font-size: 15px;
                padding: 14px 20px;
            }
        }
    </style>
</head>
<body>
    <h1 class="title">ÎÇòÎßåÏùò Îß§Î†• Î≥ÑÏûêÎ¶¨ Ïπ¥Îìú</h1>
    
    <div class="cards-container">
        <div class="card constellation-card">
            <div class="star-corner tl">‚ú¶</div>
            <div class="star-corner tr">‚ú¶</div>
            <div class="aster-logo" id="asterLogo"></div>
            <div class="subtitle">ÏïÑÎ¶ÑÎã§ÏõÄÏù¥ ÎπÑÎ°úÏÜå ÎÇòÎã§ÏõÄÏúºÎ°ú</div>
            
            <div class="constellation-preview">
                <div class="eye-background" id="eyeBackground"></div>
                <svg id="constellation-svg"></svg>
                <div class="star-field" id="starField"></div>
            </div>
            
            <div class="constellation-name" id="constellationName">Loading...</div>
            <div class="constellation-bottom">ÎßàÏπ®ÎÇ¥ Î∞úÍ≤¨Ìïú ÎÇòÎßåÏùò Î≥Ñ</div>
            <div class="star-corner bl">‚ú¶</div>
            <div class="star-corner br">‚ú¶</div>
        </div>

        <div class="card stats-card">
            <div class="star-corner tl">‚ú¶</div>
            <div class="star-corner tr">‚ú¶</div>
            <div class="aster-logo" id="asterLogo2"></div>
            
            <div class="stats-list" id="statsList"></div>
            
            <div class="constellation-bottom">ÎßàÏπ®ÎÇ¥ Î∞úÍ≤¨Ìïú ÎÇòÎßåÏùò Î≥Ñ</div>
            <div class="star-corner bl">‚ú¶</div>
            <div class="star-corner br">‚ú¶</div>
        </div>
    </div>

    <div class="buttons">
        <button class="btn btn-secondary" onclick="downloadCard()">Ïπ¥Îìú Îã§Ïö¥Î°úÎìú</button>
        <button class="btn btn-primary" onclick="sendTo3DConstellation()">3D Î≥ÑÏûêÎ¶¨Ïóê Ï∂îÍ∞Ä</button>
        <a href="main.html" class="btn btn-primary">Îã§Ïãú ÎßåÎì§Í∏∞</a>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyBcl4tKzcneq6yn6mmADC5YzoVGmRnsZbk",
            authDomain: "dinteraction-e0393.firebaseapp.com",
            databaseURL: "https://dinteraction-e0393-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "dinteraction-e0393",
            storageBucket: "dinteraction-e0393.firebasestorage.app",
            messagingSenderId: "845988355289",
            appId: "1:845988355289:web:b5243b16e80bfb9cbf32c8",
            measurementId: "G-QG1QWM3LSC"
        };
        
        // Firebase Ï¥àÍ∏∞Ìôî
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        console.log('üî• Firebase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
    
        const categoryInfo = {
            "Ïù¥Ìï¥Ïã¨ Î∞è Í≥µÍ∞ê Îä•Î†•": { color: "#D726BD", starImage: "star-pink.png", shortName: "Î¶¨ÎçîÏã≠", colorName: "pink", bgColor: "#FFE7FB" },
            "ÏÑ±Ïã§ÏÑ± Î∞è Ï±ÖÏûÑÍ∞ê": { color: "#1A99B6", starImage: "star-skyblue.png", shortName: "Î∞∞Î†§Ïã¨", colorName: "skyblue", bgColor: "#E7FBFF" },
            "ÏßÄÏ†Å Ìò∏Í∏∞Ïã¨ Î∞è Í∞úÎ∞©ÏÑ±": { color: "#CD9F1F", starImage: "star-yellow.png", shortName: "Í≥ÑÌöçÏÑ±", colorName: "yellow", bgColor: "#FEFFE4" },
            "Ï†ïÏÑúÏ†Å ÏïàÏ†ï Î∞è ÏûêÍ∏∞ Ïù∏Ïãù": { color: "#1BC14D", starImage: "star-green.png", shortName: "ÏûêÍ∏∞ Í∞ùÍ¥ÄÌôî", colorName: "green", bgColor: "#E7FFEC" },
            "ÎèÑÎçïÏÑ± Î∞è ÏñëÏã¨": { color: "#4169E1", starImage: "star-blue.png", shortName: "Ìè¨Ïö©Î†•", colorName: "blue", bgColor: "#E7F1FF" },
            "Ïú†Î®∏Í∞êÍ∞Å Î∞è ÏÇ¨ÍµêÏÑ±": { color: "#D1791A", starImage: "star-orange.png", shortName: "ÎÑìÏùÄ ÏãúÏïº", colorName: "orange", bgColor: "#FFEFE4" },
            "Î™©Ìëú ÏßÄÌñ•ÏÑ± Î∞è ÏïºÎßù": { color: "#CE2629", starImage: "star-red.png", shortName: "ÏÑ±Ïã§Ìï®", colorName: "red", bgColor: "#FFE7E7" }
        };

        const symbols = { 0: "‚ô¶", 1: "‚ô¶", 2: "‚ô¶", 3: "‚ô¶", 4: "‚ô¶", 5: "‚ô¶", 6: "‚ô¶" };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Result Page] DOMContentLoaded ÏãúÏûë');
            const savedData = localStorage.getItem('asterResultData');
            console.log('[Result Page] localStorage Îç∞Ïù¥ÌÑ∞:', savedData ? 'ÏûàÏùå' : 'ÏóÜÏùå');
            
            if (!savedData) {
                console.error('[Result Page] asterResultDataÍ∞Ä ÏóÜÏäµÎãàÎã§!');
                alert('Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. main.htmlÏóêÏÑú Î≥ÑÏûêÎ¶¨Î•º ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî.');
                window.location.href = 'main.html';
                return;
            }

            let resultData;
            try {
                resultData = JSON.parse(savedData);
                console.log('[Result Page] Îç∞Ïù¥ÌÑ∞ ÌååÏã± ÏÑ±Í≥µ:', resultData);
            } catch (error) {
                console.error('[Result Page] JSON ÌååÏã± Ïò§Î•ò:', error);
                alert('Îç∞Ïù¥ÌÑ∞ ÌòïÏãù Ïò§Î•ò');
                return;
            }
            
            // Í∞ÄÏû• ÎÜíÏùÄ Î†àÎ≤®Ïùò Î≥Ñ Ï∞æÍ∏∞
            let highestLevelCharm = null;
            let maxLevel = 0;
            
            console.log('[Result Page] charms Í∞úÏàò:', resultData.charms ? resultData.charms.length : 0);
            
            if (!resultData.charms || resultData.charms.length === 0) {
                console.error('[Result Page] charmsÍ∞Ä ÏóÜÍ±∞ÎÇò ÎπÑÏñ¥ÏûàÏäµÎãàÎã§!');
                alert('Îß§Î†• Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            resultData.charms.forEach(charm => {
                if (charm.level > maxLevel) {
                    maxLevel = charm.level;
                    highestLevelCharm = charm;
                }
            });
            
            console.log('[Result Page] Í∞ÄÏû• ÎÜíÏùÄ Î†àÎ≤® Îß§Î†•:', highestLevelCharm);
            
            // Í∞ÄÏû• ÎÜíÏùÄ Î†àÎ≤® Î≥ÑÏùò Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const dominantCategoryInfo = highestLevelCharm ? categoryInfo[highestLevelCharm.category] : null;
            const colorName = dominantCategoryInfo ? dominantCategoryInfo.colorName : 'blue';
            const bgColor = dominantCategoryInfo ? dominantCategoryInfo.bgColor : '#E7F1FF';
            
            console.log('[Result Page] colorName:', colorName);
            
            // Î≥ÑÏûêÎ¶¨ Ïù¥Î¶Ñ ÏÑ§Ï†ï
            const nameEl = document.getElementById('constellationName');
            nameEl.textContent = `${resultData.userName || 'User'}'s Constellation`;
            nameEl.setAttribute('lang', 'en');
            console.log('[Result Page] Î≥ÑÏûêÎ¶¨ Ïù¥Î¶Ñ ÏÑ§Ï†ï ÏôÑÎ£å:', nameEl.textContent);
            
            // Ïπ¥Îìú Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.style.background = `linear-gradient(145deg, ${bgColor} 0%, ${bgColor}dd 100%)`;
            });

            // Apply dominant theme color to text and corner stars
            const themeColor = dominantCategoryInfo ? dominantCategoryInfo.color : '#4169E1';
            document.querySelectorAll('.subtitle, .constellation-name, .constellation-bottom, .star-corner').forEach(el => {
                el.style.color = themeColor;
            });
            
            // Î°úÍ≥† Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
            const logoElements = [document.getElementById('asterLogo'), document.getElementById('asterLogo2')];
            logoElements.forEach(logo => {
                if (logo) {
                    logo.style.backgroundImage = `url('./images/logo-${colorName}.png')`;
                }
            });
            
            // Îàà Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
            const eyeBackground = document.getElementById('eyeBackground');
            if (eyeBackground) {
                const eyeImagePath = `./images/eye-${colorName}.png`;
                console.log('Îàà Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú:', eyeImagePath);
                console.log('colorName:', colorName);
                eyeBackground.style.backgroundImage = `url('${eyeImagePath}')`;
                console.log('eyeBackground ÏöîÏÜå:', eyeBackground);
                console.log('eyeBackground Ïä§ÌÉÄÏùº:', eyeBackground.style);
            } else {
                console.log('eyeBackground ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            }

            // Î≥ÑÎì§ ÏÉùÏÑ±
            const starField = document.getElementById('starField');
            const svg = document.getElementById('constellation-svg');
            
            resultData.charms.forEach(charm => {
                const star = document.createElement('div');
                star.className = 'constellation-star';
                star.style.left = `${charm.position.x}%`;
                star.style.top = `${charm.position.y}%`;
                // Use each charm's original star image (preserve per-charm color)
                star.style.backgroundImage = `url(./images/${charm.starImage})`;
                
                const size = charm.level > 0 ? 40 + (charm.level * 50) : 0;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                
                starField.appendChild(star);
            });

            // Ïó∞Í≤∞ÏÑ† ÏÉùÏÑ±
            console.log('Ïó∞Í≤∞ÏÑ† Îç∞Ïù¥ÌÑ∞:', resultData.lines);
            resultData.lines.forEach(line => {
                const startCharm = resultData.charms.find(c => c.name === line.start);
                const endCharm = resultData.charms.find(c => c.name === line.end);
                
                if (startCharm && endCharm) {
                    console.log(`Ïó∞Í≤∞ÏÑ† ÏÉùÏÑ±: ${startCharm.name} -> ${endCharm.name}`);
                    const lineEl = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    lineEl.setAttribute('x1', `${startCharm.position.x}%`);
                    lineEl.setAttribute('y1', `${startCharm.position.y}%`);
                    lineEl.setAttribute('x2', `${endCharm.position.x}%`);
                    lineEl.setAttribute('y2', `${endCharm.position.y}%`);
                    lineEl.className = 'constellation-line';
                    lineEl.setAttribute('stroke', 'rgba(255, 255, 255, 0.9)');
                    lineEl.setAttribute('stroke-width', '2');
                    svg.appendChild(lineEl);
                    console.log('Ïó∞Í≤∞ÏÑ† Ï∂îÍ∞ÄÎê®:', lineEl);
                } else {
                    console.log('Ïó∞Í≤∞ÏÑ† Îß§Î†•ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', line);
                }
            });

            // ÌÜµÍ≥Ñ ÏÉùÏÑ± - Í∞úÎ≥Ñ Îß§Î†•Îì§ÏùÑ Î†àÎ≤® ÏàúÏúºÎ°ú ÌëúÏãú
            const statsList = document.getElementById('statsList');
            
            resultData.charms
                .sort((a, b) => b.level - a.level)
                .slice(0, 8)
                .forEach(charm => {
                    const info = categoryInfo[charm.category];
                    const item = document.createElement('div');
                    item.className = 'stat-item';
                    item.innerHTML = `
                        <div class="stat-name" style="color: ${info.color}">${charm.name}</div>
                        <div class="stat-value">
                            <span style="color: ${info.color}">‚ô¶</span>
                            <span>${charm.level}</span>
                        </div>
                    `;
                    statsList.appendChild(item);
                });
        });

        // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨ Î°úÎî© Ìï®Ïàò
        function preloadImages() {
            return new Promise((resolve) => {
                const images = document.querySelectorAll('.aster-logo, .eye-background');
                let loadedCount = 0;
                const totalImages = images.length;
                
                if (totalImages === 0) {
                    resolve();
                    return;
                }
                
                images.forEach(img => {
                    const computedStyle = window.getComputedStyle(img);
                    const backgroundImage = computedStyle.backgroundImage;
                    
                    if (backgroundImage && backgroundImage !== 'none') {
                        const imageUrl = backgroundImage.slice(4, -1).replace(/"/g, "");
                        const image = new Image();
                        image.crossOrigin = 'anonymous';
                        image.onload = () => {
                            loadedCount++;
                            if (loadedCount === totalImages) {
                                resolve();
                            }
                        };
                        image.onerror = () => {
                            loadedCount++;
                            if (loadedCount === totalImages) {
                                resolve();
                            }
                        };
                        image.src = imageUrl;
                    } else {
                        loadedCount++;
                        if (loadedCount === totalImages) {
                            resolve();
                        }
                    }
                });
            });
        }

        async function downloadCard() {
            const btn = event.target;
            btn.textContent = 'Ï≤òÎ¶¨Ï§ë...';
            btn.disabled = true;
            
            try {
                // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨ Î°úÎî©
                await preloadImages();
                
                const container = document.querySelector('.cards-container');
                const body = document.body;
                
                // ÏûÑÏãúÎ°ú ÌéòÏù¥ÏßÄ Î∞∞Í≤ΩÏùÑ Ìà¨Î™ÖÌïòÍ≤å Î≥ÄÍ≤Ω
                const originalBackground = body.style.background;
                body.style.background = 'transparent';
                
                // Ïû†Ïãú ÎåÄÍ∏∞ÌïòÏó¨ Î†åÎçîÎßÅ ÏôÑÎ£å Î≥¥Ïû•
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const canvas = await html2canvas(container, { 
                    scale: 3, // Îçî ÎÜíÏùÄ Ìï¥ÏÉÅÎèÑ
                    backgroundColor: null,
                    useCORS: true,
                    allowTaint: true,
                    imageTimeout: 15000,
                    logging: false,
                    removeContainer: true,
                    foreignObjectRendering: true
                });
                
                // ÏõêÎûò Î∞∞Í≤ΩÏúºÎ°ú Î≥µÏõê
                body.style.background = originalBackground;
                
                const link = document.createElement('a');
                link.download = 'constellation-card.png';
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
            } catch (error) {
                // ÏóêÎü¨ Î∞úÏÉù ÏãúÏóêÎèÑ Î∞∞Í≤Ω Î≥µÏõê
                document.body.style.background = '#000';
                console.error('Îã§Ïö¥Î°úÎìú Ïò§Î•ò:', error);
                alert('Îã§Ïö¥Î°úÎìú Ïã§Ìå®');
            }
            
            btn.textContent = 'Ïπ¥Îìú Îã§Ïö¥Î°úÎìú';
            btn.disabled = false;
        }

        // 3D Î≥ÑÏûêÎ¶¨Ïóê Ï∂îÍ∞ÄÌïòÎäî Ìï®Ïàò
        async function sendTo3DConstellation() {
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Î∞è Î°úÎî© ÌëúÏãú
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Ï†ÑÏÜ° Ï§ë...';
            btn.disabled = true;
            
            try {
                const savedData = localStorage.getItem('asterResultData');
                if (!savedData) {
                    alert('Î≥ÑÏûêÎ¶¨ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                const resultData = JSON.parse(savedData);
                
                console.log('üì∏ Î≥ÑÏûêÎ¶¨ Ïù¥ÎØ∏ÏßÄ Ï∫°Ï≤ò Ï§ë...');
                btn.textContent = 'Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...';
                
                // Î≥ÑÏûêÎ¶¨ ÌîÑÎ¶¨Î∑∞ Î∂ÄÎ∂ÑÎßå Ï∫°Ï≤ò (Î≥Ñ + Ïó∞Í≤∞ÏÑ†)
                const constellationPreview = document.querySelector('.constellation-preview');
                const eyeBackground = document.getElementById('eyeBackground');
                let cardImageData = null;
                
                try {
                    // ÏõêÎ≥∏ Ïä§ÌÉÄÏùº Ï†ÄÏû•
                    const originalEyeDisplay = eyeBackground.style.display;
                    const originalBg = constellationPreview.style.background;
                    const originalBorderRadius = constellationPreview.style.borderRadius;
                    const originalOverflow = constellationPreview.style.overflow;
                    
                    // Ï∫°Ï≤òÎ•º ÏúÑÌï¥ ÏûÑÏãúÎ°ú Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
                    eyeBackground.style.display = 'none'; // ÎààÎèôÏûê Ïà®Í∏∞Í∏∞
                    constellationPreview.style.background = 'transparent'; // Î∞∞Í≤Ω Ìà¨Î™Ö
                    constellationPreview.style.borderRadius = '0'; // ÏõêÌòï ÎßàÏä§ÌÇπ Ï†úÍ±∞
                    constellationPreview.style.overflow = 'visible'; // Î≥ÑÎπõÏù¥ Î≥¥Ïù¥Í≤å
                    
                    // ÏïΩÍ∞Ñ ÎåÄÍ∏∞ (Î†åÎçîÎßÅ ÏôÑÎ£å)
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                    const canvas = await html2canvas(constellationPreview, {
                        scale: 1.5, // 2 ‚Üí 1.5Î°ú Ï§ÑÏûÑ (ÏÜçÎèÑ Í∞úÏÑ†)
                        backgroundColor: null,
                        useCORS: true,
                        allowTaint: true,
                        logging: false
                    });
                    
                    // ÏõêÎ≥∏ Ïä§ÌÉÄÏùº Î≥µÏõê
                    eyeBackground.style.display = originalEyeDisplay;
                    constellationPreview.style.background = originalBg;
                    constellationPreview.style.borderRadius = originalBorderRadius;
                    constellationPreview.style.overflow = originalOverflow;
                    
                    // Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï (JPEG, ÌíàÏßà 0.6ÏúºÎ°ú Îçî ÎÇÆÏ∂§)
                    cardImageData = canvas.toDataURL('image/jpeg', 0.6);
                    console.log('‚úÖ Î≥ÑÏûêÎ¶¨ Ïù¥ÎØ∏ÏßÄ Ï∫°Ï≤ò ÏôÑÎ£å (ÌÅ¨Í∏∞:', Math.round(cardImageData.length / 1024), 'KB)');
                } catch (error) {
                    console.error('‚ùå Î≥ÑÏûêÎ¶¨ Ï∫°Ï≤ò Ïã§Ìå®:', error);
                    // ÏóêÎü¨ Î∞úÏÉù ÏãúÏóêÎèÑ Ïä§ÌÉÄÏùº Î≥µÏõê
                    if (eyeBackground) eyeBackground.style.display = '';
                    if (constellationPreview) {
                        constellationPreview.style.background = '';
                        constellationPreview.style.borderRadius = '';
                        constellationPreview.style.overflow = '';
                    }
                }
                
                btn.textContent = 'Ï†ÑÏÜ° Ï§ë...';
                
                // 3D ÌîÑÎ°úÏ†ùÌä∏Î°ú Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                const constellationData = {
                    name: `${resultData.userName}'s Constellation`,
                    userName: resultData.userName,
                    charms: resultData.charms.map(charm => ({
                        name: charm.name,
                        level: charm.level,
                        category: charm.category,
                        position: charm.position,
                        starImage: charm.starImage
                    })),
                    lines: resultData.lines || [],
                    totalLevel: resultData.charms.reduce((sum, charm) => sum + charm.level, 0),
                    timestamp: new Date().toISOString(),
                    cardImage: cardImageData // Î≥ÑÏûêÎ¶¨ Ïù¥ÎØ∏ÏßÄÎßå Ï∂îÍ∞Ä
                };

                console.log('üåü FirebaseÎ°ú Î≥ÑÏûêÎ¶¨ Ï†ÑÏÜ° Ï§ë... (Ï¥ù ÌÅ¨Í∏∞:', Math.round(JSON.stringify(constellationData).length / 1024), 'KB)');

                // Firebase Realtime DatabaseÏóê Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                const newConstellationRef = database.ref('constellations').push();
                await newConstellationRef.set(constellationData);
                
                console.log('‚úÖ FirebaseÏóê Î≥ÑÏûêÎ¶¨ Ï∂îÍ∞Ä ÏôÑÎ£å!');
                
                btn.textContent = 'Ï†ÑÏÜ° ÏôÑÎ£å! ‚ú®';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
                
                alert('‚ú® Î≥ÑÏûêÎ¶¨Í∞Ä 3D Ïö∞Ï£ºÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!\nÏª¥Ìì®ÌÑ∞ ÌôîÎ©¥ÏùÑ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî! üåü');
                
            } catch (error) {
                console.error('‚ùå 3D Ï†ÑÏÜ° Ïò§Î•ò:', error);
                alert('Î≥ÑÏûêÎ¶¨ Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n' + error.message);
            }
        }
    </script>
</body>
</html>
